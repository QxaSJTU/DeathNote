/***

For Quantumult-X 598+ ONLY!!

[task_local]

// UI å…¥å£åˆ‡æ¢ç‰ˆæœ¬
event-interaction https://raw.githubusercontent.com/QxaSJTU/DeathNote/main/Scripts/switch-check-OpenAI, tag=OpenAI Sifter, img-url=https://raw.githubusercontent.com/fmz200/wool_scripts/main/icons/apps/OpenAI.png, enabled=true

// Cron å®šæ—¶åˆ‡æ¢ç‰ˆæœ¬
0 8 * * * https://raw.githubusercontent.com/QxaSJTU/DeathNote/main/Scripts/switch-check-OpenAI#policy=ä½ çš„ç­–ç•¥ç»„å, tag=OpenAI é€ä¸­å®šæ—¶åˆ‡æ¢, img-url=https://raw.githubusercontent.com/fmz200/wool_scripts/main/icons/apps/OpenAI.png, enabled=true


ps. ç®€å•ç²—æš´çš„ UI-Interaction ç‰ˆæœ¬ã€‚æ— æ•°æ®æŒä¹…åŒ–ã€ç²—æš´å»¶è¿Ÿç­‰å¾…ã€‚å®Œç¾ä¸»ä¹‰å»ºè®®ä½¿ç”¨ Helgeå¤§ä½¬çš„boxjsç‰ˆæœ¬ https://t.me/QuanXNews/193

@XIAO_KOP

**/

//var policy = $environment.params
var cronsign = $environment.executeType == 0 || $environment.executeType == "0" || $environment.executeType == "-1"? "Y" : "N"
var policy = $environment.executeType == 0 || $environment.executeType == "0" || $environment.executeType == "-1"? GetPolicy($environment.sourcePath) : $environment.params
const BASE_URL_GPT = 'https://chat.openai.com/';
const Region_URL_GPT = 'https://chat.openai.com/cdn-cgi/trace/';

const link = { "media-url": "https://raw.githubusercontent.com/KOP-XIAO/QuantumultX/master/img/southpark/7.png" } 
const policy_name = "Netflix" //å¡«å…¥ä½ çš„ netflix ç­–ç•¥ç»„å

const arrow = " âŸ "

const UA = 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.61 Safari/537.36'
console.log(JSON.stringify($environment))
console.log("ç­–ç•¥ç»„ï¼š"+policy)

function GetPolicy(cnt) {
    if (cnt && cnt.indexOf("#policy=") !=-1) {
        return decodeURIComponent(cnt.split("#policy=")[1].trim())
    }else {
        return ""
    }
}

const message = {
    action: "get_customized_policy",
    content: policy

};

var output=[]
var OKList=[]
var NoList=["OpenAIå¤±æ•ˆèŠ‚ç‚¹ âŸ "]
var ErrorList=["æ£€æµ‹å‡ºé”™èŠ‚ç‚¹ âŸ "]
var pflag=1 //æ˜¯å¦æ˜¯ç­–ç•¥ï¼Œæˆ–è€…ç®€å•èŠ‚ç‚¹
var sign=0 //æ˜¯å¦åœæ­¢

$configuration.sendMessage(message).then(resolve => {
    if (resolve.error) {
        console.log(resolve.error);
        $done()
    }
    if (resolve.ret) {
        //console.log(JSON.stringify(resolve.ret))
        output=JSON.stringify(resolve.ret[message.content])? JSON.parse(JSON.stringify(resolve.ret[message.content]["candidates"])) : [policy]
        pflag = JSON.stringify(resolve.ret[message.content])? pflag:0
        console.log("OpenAI æ£€æµ‹")
        console.log("èŠ‚ç‚¹orç­–ç•¥ç»„ï¼š"+pflag)

        if (pflag==1) {
        console.log("èŠ‚ç‚¹æ•°é‡ï¼š"+resolve.ret[policy]["candidates"].length)

        if(resolve.ret[policy]["candidates"].length==0) {
            $done({"title":"OpenAI æ£€æµ‹","htmlMessage":`<p style="text-align: center; font-family: -apple-system; font-size: large; font-weight: thin"><br><b>ğŸ˜­ æ— æœ‰æ•ˆèŠ‚ç‚¹</b>`});
        }
    }

        //$notify(typeof(output),output)
        Check()
        //$done({"title":"ç­–ç•¥å†…å®¹","message":output})
    }
}, reject => {
    // Normally will never happen.
    $done();
});

function Len(cnt) {
    return cnt.length-1
}

function Check() {
    var relay = 2000;
    for ( var i=0;i < output.length;i++) {
        testChatGPT(output[i])
        }
    if (output.length<=5) {
        relay = 2000
    } else if (output.length<10) {
        relay =4000
    } else if (output.length<15) {
        relay =6000
    } else if (output.length<20) {
        relay =8000
    } else {
        relay =10000
    }
    console.log(output.length+":"+relay)
    setTimeout(() => {
        console.log("â›³ï¸ å…±è®¡ "+OKList.length+" ä¸ªï¼šæœªé€ä¸­èŠ‚ç‚¹ âŸ "+ OKList)
        console.log("ğŸ  å…±è®¡ "+Len(NoList)+" ä¸ªï¼š"+NoList)
        console.log("ğŸ•¹ å…±è®¡ "+Len(ErrorList)+" ä¸ªï¼š"+ErrorList)
        sign=1
        if (OKList[0] && pflag==1) { //æœ‰æ”¯æŒèŠ‚ç‚¹ã€ä¸”ä¸ºç­–ç•¥ç»„æ‰æ“ä½œ
            ReOrder(OKList)
            } else if (!OKList[0]){ //ä¸æ”¯æŒ
                content =pflag==0 ? `<p style="text-align: center; font-family: -apple-system; font-size: large; font-weight: thin"><br><b>ğŸ˜­ è¯¥èŠ‚ç‚¹å·²è¢« OpenAI é€ä¸­ </b><br><br>ğŸ‘‡<br><br><font color=#FF5733>-------------------------<br><b>âŸ¦ `+policy+` âŸ§ </b><br>-------------------------</font>`: `<p style="text-align: center; font-family: -apple-system; font-size: large; font-weight: thin">` + "<br>âŒ  <b>âŸ¦ "+policy+ " âŸ§ </b>âš ï¸ åˆ‡æ¢å¤±è´¥<br><br><b>è¯¥ç­–ç•¥ç»„å†…æœªæ‰¾åˆ°æœªè¢« OpenAI é€ä¸­</b> çš„èŠ‚ç‚¹" + "<br><br><font color=#FF5733>-----------------------------<br><b>æ£€æµ‹è¯¦æƒ…è¯·æŸ¥çœ‹JSè„šæœ¬è®°å½•</b><br>-----------------------------</font>"+`</p>`
                //ä¸ºèŠ‚ç‚¹ä¸”æ£€æµ‹è¶…æ—¶/å‡ºé”™
                content = pflag==0 && Len(NoList)==0 ? content = `<p style="text-align: center; font-family: -apple-system; font-size: large; font-weight: thin"><br><b>âš ï¸ è¯¥èŠ‚ç‚¹ OpenAI é€ä¸­æ£€æµ‹å¤±è´¥ </b><br><br>ğŸ‘‡<br><br><font color=#FF5733>-------------------------<br><b>âŸ¦ `+policy+` âŸ§ </b><br>-------------------------</font>`: content
                $done({"title":"OpenAI é€ä¸­æ£€æµ‹&åˆ‡æ¢", "htmlMessage": content})
            } else if (OKList[0]){ //æ”¯æŒ, ä½†ä¸ºèŠ‚ç‚¹
            content = `<p style="text-align: center; font-family: -apple-system; font-size: large; font-weight: thin"><br><b> ğŸ‰ è¯¥èŠ‚ç‚¹æœªè¢« OpenAI é€ä¸­ </b><br><br>ğŸ‘‡<br><br><font color=#FF5733>-------------------------<br><b>âŸ¦ `+policy+` âŸ§ </b><br>-------------------------</font>`
            $done({"title":"OpenAI é€ä¸­æ£€æµ‹&åˆ‡æ¢", "htmlMessage": content})
        } 
    }, relay)
    
}

//é€‰æ‹©æœ€ä¼˜å»¶è¿ŸèŠ‚ç‚¹
function ReOrder(cnt) {
    const array = cnt;
    const messageURL = {
    action: "url_latency_benchmark",
    content: array
};
    $configuration.sendMessage(messageURL).then(resolve => {
    if (resolve.error) {
        console.log(resolve.error);
    }
    if (resolve.ret) {
        let output=JSON.stringify(resolve.ret);
        console.log("èŠ‚ç‚¹å»¶è¿Ÿï¼š"+output);
        //æ’åº
        console.log("æ’åºå‰: "+ array)
        if(array){
            try {
        array.sort(function (a,b) {
            //console.log(a+" VS "+b)
        return (resolve.ret[a][1]!=-1 && resolve.ret[b][1] !=-1)? resolve.ret[a][1]-resolve.ret[b][1] : resolve.ret[b][1]
    })
    } catch (err) {
        console.log(err)
    }
    }  
    console.log("æ’åºå: "+array)
    let Ping =resolve.ret[array[0]]
        const dict = { [policy] : array[0]};
        if(array[0]) {
            console.log("é€‰å®šæœªè¢«é€ä¸­èŠ‚ç‚¹ï¼š"+array[0]+"å»¶è¿Ÿæ•°æ®ä¸º ğŸ‘‰"+Ping)
            Ping = " âš¡ï¸ èŠ‚ç‚¹å»¶è¿Ÿ âŸ ã€Œ "+Ping + " ã€ "
        }
        const mes1 = {
            action: "set_policy_state",
            content: dict
        }; 
        $configuration.sendMessage(mes1).then(resolve => {
            if (resolve.error) {
                console.log(resolve.error);
                content =pflag==0 && array[0]? `<p style="text-align: center; font-family: -apple-system; font-size: large; font-weight: thin"><br><b> ğŸ‰ è¯¥èŠ‚ç‚¹æœªè¢« OpenAI é€ä¸­ </b><br><br>ğŸ‘‡<br><br><font color=#FF5733>-------------------------<br><b>âŸ¦ `+policy+` âŸ§ </b><br>-------------------------</font>` : `<p style="text-align: center; font-family: -apple-system; font-size: large; font-weight: thin"><br><b>ğŸ˜­ è¯¥èŠ‚ç‚¹å·²è¢« OpenAI é€ä¸­ </b><br><br>ğŸ‘‡<br><br><font color=#FF5733>-------------------------<br><b>âŸ¦ `+policy+` âŸ§ </b><br>-------------------------</font>`
                content = pflag!=0 && !array[0]? `<p style="text-align: center; font-family: -apple-system; font-size: large; font-weight: thin">` + "<br>âŒ  <b>âŸ¦ "+policy+ " âŸ§ </b>âš ï¸ åˆ‡æ¢å¤±è´¥<br><br><b>è¯¥ç­–ç•¥ç»„å†…æœªæ‰¾åˆ°æœªè¢« OpenAI é€ä¸­</b> çš„èŠ‚ç‚¹" + "<br><br><font color=#FF5733>-----------------------------<br><b>æ£€æµ‹è¯¦æƒ…è¯·æŸ¥çœ‹JSè„šæœ¬è®°å½•</b><br>-----------------------------</font>"+`</p>` : content
                $done({"title":"OpenAI é€ä¸­æ£€æµ‹&åˆ‡æ¢", "htmlMessage": content})
            }
            if (resolve.ret) {
                console.log("å·²ç»åˆ‡æ¢è‡³æœªè¢« <b>OpenAI é€ä¸­</b> çš„è·¯çº¿ä¸­å»¶è¿Ÿæœ€ä¼˜èŠ‚ç‚¹ âŸ "+array[0])
                if (cronsign == "Y") { $notify("ğŸ¸ OpenAI å®šæ—¶é€ä¸­æ£€æµ‹&åˆ‡æ¢", "ğŸ‰ å·²åˆ‡æ¢è‡³æœªè¢«é€ä¸­çš„æœ€ä¼˜å»¶è¿Ÿçº¿è·¯ğŸ‘‡", array[0] +"\n ğŸ‘‰ "+Ping)}
                content = `<p style="text-align: center; font-family: -apple-system; font-size: large; font-weight: thin">` + "<br><b>âŸ¦ "+policy+ " âŸ§ </b>å·²åˆ‡æ¢è‡³æœªè¢«<b>OpenAI</b> é€ä¸­å»¶è¿Ÿæœ€ä¼˜è·¯çº¿<br><br> ğŸ‘‡<br><br> âŸ¦ "+array[0]+ " âŸ§" + "<br><br><font color=#16A085>"+Ping+"</font><br><font color=#FF5733>-----------------------------<br><b>æ£€æµ‹è¯¦æƒ…è¯·æŸ¥çœ‹JSè„šæœ¬è®°å½•</b><br>-----------------------------</font>"+`</p>`
                $done({"title":"OpenAI é€ä¸­æ£€æµ‹&åˆ‡æ¢", "htmlMessage": content })
            }
    }, reject => {
            $done();
        });
        
    }
    //$done();
}, reject => {
    // Normally will never happen.
    $done();
});
}

support_countryCodes=["T1","XX","AL","DZ","AD","AO","AG","AR","AM","AU","AT","AZ","BS","BD","BB","BE","BZ","BJ","BT","BA","BW","BR","BG","BF","CV","CA","CL","CO","KM","CR","HR","CY","DK","DJ","DM","DO","EC","SV","EE","FJ","FI","FR","GA","GM","GE","DE","GH","GR","GD","GT","GN","GW","GY","HT","HN","HU","IS","IN","ID","IQ","IE","IL","IT","JM","JP","JO","KZ","KE","KI","KW","KG","LV","LB","LS","LR","LI","LT","LU","MG","MW","MY","MV","ML","MT","MH","MR","MU","MX","MC","MN","ME","MA","MZ","MM","NA","NR","NP","NL","NZ","NI","NE","NG","MK","NO","OM","PK","PW","PA","PG","PE","PH","PL","PT","QA","RO","RW","KN","LC","VC","WS","SM","ST","SN","RS","SC","SL","SG","SK","SI","SB","ZA","ES","LK","SR","SE","CH","TH","TG","TO","TT","TN","TR","TV","UG","AE","US","UY","VU","ZM","BO","BN","CG","CZ","VA","FM","MD","PS","KR","TW","TZ","TL","GB"]

function testChatGPT(pname) {
  return new Promise((resolve, reject) => {
    // å®šä¹‰è¯·æ±‚é€‰é¡¹
    var opts1 = {policy: pname,redirection: false};
    let option = {
      url: BASE_URL_GPT,  // ChatGPTçš„åŸºæœ¬URL
      opts: opts1,        // ä¸€äº›é…ç½®é€‰é¡¹ï¼Œå¯èƒ½åŒ…æ‹¬å¦‚ä½•å¤„ç†HTTPè¯·æ±‚ã€è¶…æ—¶è®¾ç½®ç­‰
      timeout: 2800,      // è¯·æ±‚è¶…æ—¶æ—¶é—´è®¾ç½®ä¸º2800æ¯«ç§’
    }
    // å‘èµ·HTTPè¯·æ±‚
    $task.fetch(option).then(response => {
      let sCode = response.statusCode
      let resp = JSON.stringify(response)  // å°†å“åº”è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²
      console.log("ChatGPT Main Test")     // æ§åˆ¶å°è¾“å‡ºæµ‹è¯•ä¿¡æ¯
      let jdg = resp.indexOf("text/plain") // æ£€æŸ¥å“åº”ä¸­æ˜¯å¦å«æœ‰"text/plain"

      if (jdg == -1) {  // å¦‚æœæ²¡æœ‰æ‰¾åˆ°"text/plain"
        var opts1 = {policy: pname,redirection: false};
        let option1 = {
          url: Region_URL_GPT,  // åœ°åŒºç‰¹å®šçš„ChatGPT URL
          opts: opts1,          // ä½¿ç”¨ç›¸åŒçš„è¯·æ±‚é…ç½®
          timeout: 2800,        // ç›¸åŒçš„è¶…æ—¶è®¾ç½®
        }
        // å†æ¬¡å‘èµ·HTTPè¯·æ±‚ï¼Œæ­¤æ¬¡é’ˆå¯¹ç‰¹å®šåœ°åŒºçš„URL
        $task.fetch(option1).then(response => {
          console.log("ChatGPT Region Test")  // è¾“å‡ºåœ°åŒºæµ‹è¯•ä¿¡æ¯
          // ä»å“åº”ä½“ä¸­æå–åœ°åŒºä»£ç 
          let region = response.body.split("loc=")[1].split("\n")[0]
          console.log("ChatGPT Region: " + region)  // è¾“å‡ºåœ°åŒºä»£ç 
          // æ£€æŸ¥åœ°åŒºä»£ç æ˜¯å¦åœ¨æ”¯æŒçš„å›½å®¶ä»£ç åˆ—è¡¨ä¸­
          let res = support_countryCodes.indexOf(region)
          if (res != -1) {
            // å¦‚æœæ‰¾åˆ°ï¼Œè®¾ç½®ç»“æœä¸ºæ”¯æŒï¼Œå¹¶æ˜¾ç¤ºå¯¹åº”çš„å›½å®¶æ——å¸œ
            OKList.push(pname)//ç»“æŸå‰æ¨é€
            console.log(pname + ": è¯¥èŠ‚ç‚¹æœªè¢«é€ä¸­ ->" +sCode)
            resolve("No")
            return
          } else {
            // å¦‚æœä¸æ”¯æŒï¼Œè®¾ç½®ç›¸åº”çš„ç»“æœ
            NoList.push(pname)
            console.log(pname + ": è¯¥èŠ‚ç‚¹å·²è¢«é€ä¸­ ->" +sCode)
            resolve("YES")
            return
          }
        }, reason => {
          // è¯·æ±‚å¤±è´¥çš„é”™è¯¯å¤„ç†
          console.log("Check-Error" + reason)
          resolve("ChatGPT failed")  // è§£æä¸ºæµ‹è¯•å¤±è´¥
        })
      } else {
        // å¦‚æœä¸»è¯·æ±‚ä¸­æ‰¾åˆ°äº†"text/plain"
        result["ChatGPT"] = "<b>ChatGPT: </b>æœªæ”¯æŒ ğŸš«"
        console.log("ä¸æ”¯æŒ ChatGPT")
        resolve("ä¸æ”¯æŒ ChatGPT")
      }
    }, reason => {
            if (sign==0) {
            ErrorList.push(pname)
            console.log(pname + ": è¯¥èŠ‚ç‚¹æ£€æµ‹å¤±è´¥")
            reject("Error")
        }
            return
        })
  })
}


function testOpenAI(pname) {
    return new Promise((resolve, reject) => {
        const url = `https://chat.openai.com/`;
        let opts = { policy : pname }
        const method = `GET`;
        const headers = {
            'Accept-Encoding' : `gzip, deflate, br`,
            'Connection' : `keep-alive`,
            'Accept' : `text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8`,
            'Host' : `www..com`,
            'User-Agent' : `Mozilla/5.0 (iPhone; CPU iPhone OS 15_2 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.1 Mobile/15E148 Safari/604.1`,
            'Accept-Language' : `zh-CN,zh-Hans;q=0.9`
        };
        const body = ``;
        const myRequest = {
            url: url,
            method: method,
            headers: headers,
            body: body,
            opts: opts,
            //timeout: 3000
        };
        
        $task.fetch(myRequest).then(response => {
            let sCode = response.statusCode
            hmessage = "è¯¥èŠ‚ç‚¹æœªè¢«é€ä¸­"
            //console.log(pname+sCode);
            if (sign==0) {
            if (sCode == 400) {
                NoList.push(pname)
                console.log(pname + ": è¯¥èŠ‚ç‚¹å·²è¢«é€ä¸­ ->" +sCode)
                resolve("YES")
                return
            } else {
                OKList.push(pname)//ç»“æŸå‰æ¨é€
                console.log(pname + ": è¯¥èŠ‚ç‚¹æœªè¢«é€ä¸­ ->" +sCode)
                resolve("No")
                return
            }
        } else {
            return
        }
        }, reason => {
            if (sign==0) {
            ErrorList.push(pname)
            console.log(pname + ": è¯¥èŠ‚ç‚¹æ£€æµ‹å¤±è´¥")
            reject("Error")
        }
            return
        });
        })
    }
